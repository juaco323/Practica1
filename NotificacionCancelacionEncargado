{
  "name": "Cancelar Reserva",
  "nodes": [
    {
      "parameters": {
        "path": "cancelar-reserva",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "e822c775-811c-48f1-b413-efdf5b2c70dd",
      "name": "Webhook - Cancelar Reserva",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -1664,
        384
      ],
      "webhookId": "0ccdecf6-cdc1-4c5d-b62e-1c9d21a6cf23",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "functionCode": "const q = $json.query || {};\nconst accion = (q.accion || '').toLowerCase();\n\nif (accion !== 'cancelar') {\n  return [{ json: { ok: false, reason: 'Acci√≥n inv√°lida' } }];\n}\n\nconst reservationId = q.reservationId || '';\n\nif (!reservationId) {\n  return [{ json: { ok: false, reason: 'reservationId requerido' } }];\n}\n\nreturn [{ json: { ok: true, reservationId } }];"
      },
      "id": "8d6c01e2-c762-4507-9098-c8ff98267a04",
      "name": "Validar Datos",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1472,
        384
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1n66HEZRlQ2SeqWs0UVmgNoBYkN7gZvjlFvJYdpwwDlw",
          "mode": "list",
          "cachedResultName": "Registro Solicitud"
        },
        "sheetName": {
          "__rl": true,
          "value": 1989465276,
          "mode": "list",
          "cachedResultName": "Respuestas de formulario 1"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "ID_Reserva",
              "lookupValue": "={{ $json.reservationId }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -1312,
        384
      ],
      "id": "22652941-8f07-461f-a457-98c505c21ce4",
      "name": "Get row(s) in sheet",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "34budN9DeJBjxOOA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "={{ $json.ID_Sala }}",
          "mode": "id"
        },
        "eventId": "={{ $json.Event_ID }}",
        "options": {}
      },
      "id": "fb5556a8-ac91-486a-8fae-c7278fd322a2",
      "name": "Eliminar Evento (Google Calendar)",
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1,
      "position": [
        -1088,
        272
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "NED2jxGUvE19xj1Q",
          "name": "Google Calendar account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1088,
        432
      ],
      "id": "4f8c0f38-146e-45e8-a783-d18cf59f3779",
      "name": "Edit Fields",
      "alwaysOutputData": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -880,
        384
      ],
      "id": "6dac0010-83ae-4049-b2e5-5deec0c54576",
      "name": "Merge",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst validItem = items.find(item => !item.json.error);\nreturn validItem ? [validItem] : [items[items.length - 1]];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        384
      ],
      "id": "7991a359-1bad-4ea5-a1a0-d7f890ed160e",
      "name": "Filter Valid Data",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1n66HEZRlQ2SeqWs0UVmgNoBYkN7gZvjlFvJYdpwwDlw",
          "mode": "list",
          "cachedResultName": "Registro Solicitud",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1n66HEZRlQ2SeqWs0UVmgNoBYkN7gZvjlFvJYdpwwDlw/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1989465276,
          "mode": "list",
          "cachedResultName": "Respuestas de formulario 1"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID_Reserva": "={{ $json.ID_Reserva }}",
            "Nombre": "={{ $json.Nombre }}",
            "Correo electr√≥nico": "={{ $json['Correo electr√≥nico'] }}",
            "Fecha de la reuni√≥n": "={{ $json['Fecha de la reuni√≥n'] }}",
            "Hora de inicio": "={{ $json['Hora de inicio'] }}",
            "Hora de Termino": "={{ $json['Hora de Termino'] }}",
            "N√∫mero de participantes": "={{ $json['N√∫mero de participantes'] }}",
            "ID_Sala": "={{ $json.ID_Sala }}",
            "Event_ID": "={{ $json.Event_ID }}",
            "row_number": 0,
            "√Årea/Departamento": "={{ $json['√Årea/Departamento'] }}"
          },
          "matchingColumns": [
            "ID_Reserva"
          ],
          "schema": [
            {
              "id": "Marca temporal",
              "displayName": "Marca temporal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Nombre",
              "displayName": "Nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Correo electr√≥nico",
              "displayName": "Correo electr√≥nico",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "√Årea/Departamento",
              "displayName": "√Årea/Departamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Fecha de la reuni√≥n",
              "displayName": "Fecha de la reuni√≥n",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hora de inicio",
              "displayName": "Hora de inicio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Hora de Termino",
              "displayName": "Hora de Termino",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "N√∫mero de participantes",
              "displayName": "N√∫mero de participantes",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ID_Reserva",
              "displayName": "ID_Reserva",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ID_Sala",
              "displayName": "ID_Sala",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Event_ID",
              "displayName": "Event_ID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -592,
        384
      ],
      "id": "eea04697-176e-4842-9fa8-197f5b61e845",
      "name": "Update row in sheet",
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "34budN9DeJBjxOOA",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json['Correo electr√≥nico'] }}",
        "subject": "=  ‚ùå Reserva cancelada ‚Äî {{ $json['ID_Sala'] }} ‚Äî {{ $json['Fecha de la reuni√≥n'] }}",
        "message": "=<!doctype html>\n<html lang=\"es\">\n<head>\n    <meta charset=\"utf-8\">\n    <meta name=\"x-apple-disable-message-reformatting\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <title>Reserva cancelada</title>\n</head>\n\n<body style=\"margin:0;padding:0;background:#0f172a;\">\n    <!-- Wrapper -->\n    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\" style=\"background:#0f172a;\">\n        <tr>\n            <td align=\"center\" style=\"padding:32px 16px;\">\n\n                <!-- Card -->\n                <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" width=\"100%\"\n                       style=\"max-width:640px;background:#ffffff;border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(2,6,23,.25);\">\n\n                    <!-- Header -->\n                    <tr>\n                        <td style=\"background:#ef4444; background-image:linear-gradient(135deg,#ef4444 0%,#b91c1c 100%);padding:28px 28px 24px 28px;\">\n                            <table role=\"presentation\" width=\"100%\">\n                                <tr>\n                                    <td style=\"font-family:Arial,Helvetica,sans-serif;color:#fff;font-size:24px;line-height:1.2;font-weight:800;letter-spacing:.2px;\">\n                                        ‚ùå Reserva cancelada\n                                    </td>\n                                    <td align=\"right\" style=\"white-space:nowrap;\">\n                                        <span style=\"display:inline-block;background:#ffffff22;border:1px solid #ffffff55;color:#fff;font-family:Arial,Helvetica,sans-serif;font-size:12px;font-weight:700;padding:6px 10px;border-radius:999px;text-transform:uppercase;letter-spacing:.6px;\">\n                                            Estado: Cancelada\n                                        </span>\n                                    </td>\n                                </tr>\n                            </table>\n\n                            <div style=\"font-family:Arial,Helvetica,sans-serif;color:#ffe4e6;font-size:14px;margin-top:4px;\">\n                                Hola <strong>{{$json[\"Nombre\"] || \"Invitado/a\"}}</strong>, tu reserva se cancel√≥ exitosamente.\n                            </div>\n                        </td>\n                    </tr>\n\n                    <!-- Body -->\n                    <tr>\n                        <td style=\"padding:24px 24px 8px 24px;\">\n\n                            <!-- Summary Bar -->\n                            <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\"\n                                   style=\"border-collapse:separate;border-spacing:0 12px;\">\n                                <tr>\n                                    <td style=\"background:#f8fafc;border:1px solid #e2e8f0;border-radius:12px;padding:16px;\">\n                                        <table role=\"presentation\" width=\"100%\">\n                                            <tr>\n                                                <td style=\"font-family:Arial,Helvetica,sans-serif;font-size:14px;color:#334155;\">\n                                                    <div style=\"font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.4px;\">Sala</div>\n                                                    <div style=\"font-size:16px;font-weight:700;color:#0f172a;\">\n                                                        {{$json[\"Sala asignada\"] || \"-\"}}\n                                                    </div>\n                                                </td>\n\n                                                <td style=\"font-family:Arial,Helvetica,sans-serif;font-size:14px;color:#334155;\" align=\"center\">\n                                                    <div style=\"font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.4px;\">Fecha</div>\n                                                    <div style=\"font-size:16px;font-weight:700;color:#0f172a;\">\n                                                        {{$json[\"Fecha\"] || \"-\"}}\n                                                    </div>\n                                                </td>\n\n                                                <td style=\"font-family:Arial,Helvetica,sans-serif;font-size:14px;color:#334155;\" align=\"right\">\n                                                    <div style=\"font-size:12px;color:#64748b;text-transform:uppercase;letter-spacing:.4px;\">Horario</div>\n                                                    <div style=\"font-size:16px;font-weight:700;color:#0f172a;\">\n                                                        {{$json[\"horaInicio\"] || \"-\"}} ‚Äì {{$json[\"horaTermino\"] || \"-\"}}\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n                            </table>\n\n                            <!-- Details Grid -->\n                            <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-top:8px;\">\n\n                                <!-- row 1 -->\n                                <tr>\n                                    <td width=\"50%\" valign=\"top\" style=\"padding:8px;\">\n                                        <table role=\"presentation\" width=\"100%\"\n                                               style=\"background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;\">\n                                            <tr>\n                                                <td style=\"padding:14px 16px;\">\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;\">\n                                                        √Årea / Departamento\n                                                    </div>\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:15px;color:#111827;font-weight:700;margin-top:4px;\">\n                                                        {{$json[\"Area/Departamento\"] || \"-\"}}\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n\n                                    <td width=\"50%\" valign=\"top\" style=\"padding:8px;\">\n                                        <table role=\"presentation\" width=\"100%\"\n                                               style=\"background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;\">\n                                            <tr>\n                                                <td style=\"padding:14px 16px;\">\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;\">\n                                                        Participantes\n                                                    </div>\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:15px;color:#111827;font-weight:700;margin-top:4px;\">\n                                                        {{$json[\"N¬∞ Participantes\"] || 0}}\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n\n                                <!-- row 2 -->\n                                <tr>\n                                    <td width=\"50%\" valign=\"top\" style=\"padding:8px;\">\n                                        <table role=\"presentation\" width=\"100%\"\n                                               style=\"background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;\">\n                                            <tr>\n                                                <td style=\"padding:14px 16px;\">\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;\">\n                                                        Solicitante\n                                                    </div>\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:15px;color:#111827;font-weight:700;margin-top:4px;\">\n                                                        {{$json[\"Nombre\"] || \"-\"}}\n                                                    </div>\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:13px;color:#374151;margin-top:2px;\">\n                                                        {{$json[\"Correo\"] || \"-\"}}\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n\n                                    <td width=\"50%\" valign=\"top\" style=\"padding:8px;\">\n                                        <table role=\"presentation\" width=\"100%\"\n                                               style=\"background:#ffffff;border:1px solid #e5e7eb;border-radius:12px;\">\n                                            <tr>\n                                                <td style=\"padding:14px 16px;\">\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:12px;color:#6b7280;text-transform:uppercase;letter-spacing:.4px;\">\n                                                        ID de Reserva\n                                                    </div>\n                                                    <div style=\"font-family:Arial,Helvetica,sans-serif;font-size:13px;color:#111827;font-weight:700;margin-top:4px;word-break:break-all;\">\n                                                        {{$json[\"ID_Reserva\"] || \"-\"}}\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        </table>\n                                    </td>\n                                </tr>\n                            </table>\n\n                            <!-- Info Box -->\n                            <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-top:16px;\">\n                                <tr>\n                                    <td style=\"background:#fef2f2;border:1px solid #fecaca;border-radius:12px;padding:14px;\">\n                                        <div style=\"font-family:Arial,Helvetica,sans-serif;color:#991b1b;font-size:14px;\">\n                                            La sala ha sido liberada para otros usuarios. Si necesitas <strong>reagendar</strong>, crea una nueva solicitud desde el sistema.\n                                        </div>\n                                    </td>\n                                </tr>\n                            </table>\n\n                            <!-- Divider -->\n                            <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" style=\"margin-top:20px;\">\n                                <tr>\n                                    <td style=\"border-top:1px dashed #e5e7eb;height:1px;line-height:1px;font-size:0;\">&nbsp;</td>\n                                </tr>\n                            </table>\n\n                            <!-- Footer text -->\n                            <div style=\"font-family:Arial,Helvetica,sans-serif;color:#6b7280;font-size:12px;margin-top:12px;\">\n                                Si crees que esta cancelaci√≥n fue un error, responde a este correo indicando el <strong>ID de Reserva</strong>.\n                            </div>\n                        </td>\n                    </tr>\n\n                    <!-- Footer -->\n                    <tr>\n                        <td style=\"background:#f8fafc;padding:16px;text-align:center;border-top:1px solid #e5e7eb;\">\n                            <div style=\"font-family:Arial,Helvetica,sans-serif;color:#64748b;font-size:12px;\">\n                                Sistema de Reservas ‚Ä¢ Colegios Arzobispado SSMA\n                            </div>\n                        </td>\n                    </tr>\n\n                </table>\n                <!-- /Card -->\n\n            </td>\n        </tr>\n    </table>\n    <!-- /Wrapper -->\n</body>\n</html>\n",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -288,
        224
      ],
      "id": "e509ee91-d028-4e3c-9794-e80b0e21ce9a",
      "name": "Email al Solicitante",
      "alwaysOutputData": true,
      "webhookId": "7007a912-8675-4b67-beb3-b2f3b03db1f5",
      "credentials": {
        "gmailOAuth2": {
          "id": "4dg8XxfS4VnD9AxH",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "encargadosalas131@gmail.com",
        "subject": "=‚ö†Ô∏è CANCELACI√ìN - {{ $json['Sala asignada'] || 'Sala' }} - {{ $json['Fecha de la reuni√≥n'] || '-' }}",
        "message": "=<!doctype html>\n<html lang=\"es\">\n<head>\n  <meta charset=\"utf-8\">\n  <title>Notificaci√≥n de Cancelaci√≥n</title>\n</head>\n<body style=\"margin:0;padding:0;background:#f5f5f5;font-family:Arial,sans-serif;\">\n  <table role=\"presentation\" width=\"100%\" style=\"background:#f5f5f5;padding:40px 20px;\">\n    <tr>\n      <td align=\"center\">\n        <table role=\"presentation\" style=\"max-width:600px;width:100%;background:#ffffff;border-radius:12px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,0.1);\">\n          <tr>\n            <td style=\"background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);padding:24px;text-align:center;\">\n              <h1 style=\"margin:0;color:#ffffff;font-size:24px;font-weight:700;\">‚ö†Ô∏è Reserva Cancelada</h1>\n              <p style=\"margin:8px 0 0;color:#fee;font-size:14px;\">Notificaci√≥n para reorganizar espacios</p>\n            </td>\n          </tr>\n          <tr>\n            <td style=\"padding:32px 24px;\">\n              <p style=\"font-size:16px;color:#333;margin:0 0 24px;\">Hola <strong>Encargado de Salas</strong>,</p>\n              <p style=\"font-size:15px;color:#555;margin:0 0 24px;line-height:1.6;\">Se ha <strong style=\"color:#dc2626;\">cancelado</strong> una reserva. Detalles:</p>\n              <table role=\"presentation\" width=\"100%\" style=\"background:#fef2f2;border:1px solid #fecaca;border-radius:8px;margin-bottom:24px;\">\n                <tr><td style=\"padding:16px;\">\n                  <table role=\"presentation\" width=\"100%\">\n                    <tr><td style=\"padding:8px 0;font-size:14px;color:#666;width:40%;\"><strong>üè¢ Sala:</strong></td><td style=\"padding:8px 0;font-size:14px;color:#111;\">{{ $json['Sala asignada'] || '-' }}</td></tr>\n                    <tr><td style=\"padding:8px 0;font-size:14px;color:#666;\"><strong>üìÖ Fecha:</strong></td><td style=\"padding:8px 0;font-size:14px;color:#111;\">{{ $json['Fecha de la reuni√≥n'] || '-' }}</td></tr>\n                    <tr><td style=\"padding:8px 0;font-size:14px;color:#666;\"><strong>üïê Horario:</strong></td><td style=\"padding:8px 0;font-size:14px;color:#111;\">{{ $json['Hora de inicio'] || '-' }} - {{ $json['Hora de Termino'] || '-' }}</td></tr>\n                    <tr><td style=\"padding:8px 0;font-size:14px;color:#666;\"><strong>üë§ Solicitante:</strong></td><td style=\"padding:8px 0;font-size:14px;color:#111;\">{{ $json.Nombre || '-' }}<br><span style=\"font-size:13px;color:#666;\">{{ $json['Correo electr√≥nico'] || '-' }}</span></td></tr>\n                    <tr><td style=\"padding:8px 0;font-size:14px;color:#666;\"><strong>üèõÔ∏è √Årea:</strong></td><td style=\"padding:8px 0;font-size:14px;color:#111;\">{{ $json['Area/Departamento'] || '-' }}</td></tr>\n                    <tr><td style=\"padding:8px 0;font-size:14px;color:#666;\"><strong>üë• Participantes:</strong></td><td style=\"padding:8px 0;font-size:14px;color:#111;\">{{ $json['N√∫mero de participantes'] || '-' }}</td></tr>\n                    <tr><td style=\"padding:8px 0;font-size:14px;color:#666;\"><strong>üîñ ID Reserva:</strong></td><td style=\"padding:8px 0;font-size:12px;color:#888;font-family:monospace;\">{{ $json.ID_Reserva || '-' }}</td></tr>\n                  </table>\n                </td></tr>\n              </table>\n              <div style=\"background:#f0fdf4;border-left:4px solid #22c55e;padding:16px;margin-bottom:24px;\">\n                <h3 style=\"margin:0 0 12px;font-size:16px;color:#15803d;\">üìã Acciones Requeridas:</h3>\n                <ul style=\"margin:0;padding-left:20px;color:#166534;font-size:14px;line-height:1.8;\">\n                  <li>Verificar disponibilidad de la sala</li>\n                  <li>Reorganizar espacios si es necesario</li>\n                  <li>Actualizar calendario de reservas</li>\n                  <li>La sala ya est√° disponible para nuevas reservas</li>\n                </ul>\n              </div>\n              <p style=\"font-size:13px;color:#888;margin:0;\">Sistema de gesti√≥n de salas - Colegios Arzobispado SSMA</p>\n            </td>\n          </tr>\n        </table>\n      </td>\n    </tr>\n  </table>\n</body>\n</html>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -288,
        528
      ],
      "id": "ac4c90ab-0a03-49e1-90d6-2094048e652c",
      "name": "Email al Encargado",
      "alwaysOutputData": true,
      "webhookId": "7df627a9-b95b-4e3d-9363-3b5861a7bb86",
      "credentials": {
        "gmailOAuth2": {
          "id": "4dg8XxfS4VnD9AxH",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -112,
        384
      ],
      "id": "d14d360f-5c6a-4a60-99e7-b3afa6af9323",
      "name": "Merge Emails",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        96,
        384
      ],
      "id": "4355c574-963b-4fd7-8fa9-2e1c22e7efc3",
      "name": "Responder al Webhook",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Normalizar nombres de campos para los emails\nconst item = $json;\n\n// Obtener valores con m√∫ltiples posibles nombres de campos\nconst sala = item.ID_Sala || item['Sala asignada'] || item['Sala asignada '] || item.Sala || '-';\nconst area = item['√Årea/Departamento'] || item['Area/Departamento'] || item.√Årea || item.Area || '-';\nconst participantes = item['N√∫mero de participantes'] || item['N√∫mero de participantes '] || item.Participantes || item['N¬∞ Participantes'] || 0;\n\n// Para debug - ver qu√© campos est√°n disponibles\nconsole.log('Campos disponibles:', Object.keys(item));\nconsole.log('ID_Sala:', item.ID_Sala);\nconsole.log('Sala asignada:', item['Sala asignada']);\n\nreturn [{\n  json: {\n    // Datos originales para actualizar Google Sheets\n    ID_Reserva: item.ID_Reserva,\n    Nombre: item.Nombre,\n    'Correo electr√≥nico': item['Correo electr√≥nico'],\n    '√Årea/Departamento': area,\n    'Fecha de la reuni√≥n': item['Fecha de la reuni√≥n'],\n    'Hora de inicio': item['Hora de inicio'],\n    'Hora de Termino': item['Hora de Termino'],\n    'N√∫mero de participantes': participantes,\n    'Sala asignada': sala,  // Ahora usa ID_Sala como valor principal\n    ID_Sala: item.ID_Sala,\n    Event_ID: item.Event_ID,\n    \n    // Campos para compatibilidad con emails del solicitante\n    Sala: sala,\n    Fecha: item['Fecha de la reuni√≥n'],\n    horaInicio: item['Hora de inicio'],\n    horaTermino: item['Hora de Termino'],\n    Participantes: participantes,\n    Area: area,\n    Correo: item['Correo electr√≥nico'],\n    \n    // Campos adicionales para email del encargado\n    'Sala asignada': sala,  // Usa ID_Sala como valor principal\n    'Area/Departamento': area,\n    'N¬∞ Participantes': participantes\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -448,
        224
      ],
      "id": "803759fb-e073-4b98-91a7-55ec90389ac9",
      "name": "Preparar datos gmail"
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook - Cancelar Reserva": {
      "main": [
        [
          {
            "node": "Validar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Datos": {
      "main": [
        [
          {
            "node": "Get row(s) in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        [
          {
            "node": "Eliminar Evento (Google Calendar)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Eliminar Evento (Google Calendar)": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Filter Valid Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Valid Data": {
      "main": [
        [
          {
            "node": "Update row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update row in sheet": {
      "main": [
        [
          {
            "node": "Preparar datos gmail",
            "type": "main",
            "index": 0
          },
          {
            "node": "Email al Encargado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email al Solicitante": {
      "main": [
        [
          {
            "node": "Merge Emails",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email al Encargado": {
      "main": [
        [
          {
            "node": "Merge Emails",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Emails": {
      "main": [
        [
          {
            "node": "Responder al Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar datos gmail": {
      "main": [
        [
          {
            "node": "Email al Solicitante",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "43e398ca-c0b6-4b41-afbb-f3ceddcb1c6c",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a1bf6c00931cbc5747bd6ebeacf79c70989884e61a83e8738f8589c81407c995"
  },
  "id": "i526BMeXUeINiPhR",
  "tags": []
}
  ]
}
